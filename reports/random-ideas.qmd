---
title: "Fun with Di..."
format: revealjs
---

## Plan

- Graphics and survey data 

<br>

- Scatterplots with weights 

<br>

- Possible things to do 

# Graphics and survey data 

## Complex surveys data analysis  
Lumley's book, Chapter 4: Graphics 

Main issue to viz complex survey data is representing the sample weights.

**3 Strategies:**

1. Based the graph on an estimated population distribution. OK  (bars, boxplots, etc)    

2. Explicitly indicate the weights in the graph. 

3. Draw a simple random sample from the estimated population distribution and graph this sample instead.



Challenge: scatter plot, smoothers 


# Scatter plot with weights: papers

## A few papers .... 
- Scatterplots with Survey Data. Korn and Graubard 1998. *The American Statistician*

- Fitting Regression Models to Survey Data. Lumley and Scott 2017. *Statistical Science*. 

- Scatterplots: Tasks, Data, and Designs. Sarikaya and Gleicher, 2018. *IEEE Vis and comp graphics*. 

- Generalized Scatter Plots. Hao, Janetzco and Bak 2010. Information visualization. 

## Basic/main/suggested options

- Bubble plot: use weights for point size (recomended for small data)



- Transparency: use weights in the transparency (alpha) parameter (for large data sets)



- Hex diagram: use hexbin instead of points (for large data sets)



- Inverse sampling: get a subsample with prob $\propto$ weights, is aprox a SRS from population


## Basic/main/suggested options

There is not an empirical evaluation of the techniques in the context of survey data.

Not sure is this comment is up to date ???


## Academic performance index (API) data 

The Academic Performance Index is computed for all California schools based on standardized testing of students. The data sets contain information for all schools with at least 100 students and for various probability samples of the data.

```{r}
#| echo: true
library(survey)
data(api)
```

Entire population, simple sample, stratified sample, two phase sample. 

## Api 2000 vs parent education

```{r}
library(patchwork)
library(tidyverse)

dstrat<-svydesign(id=~1,strata=~stype, weights=~pw, data=apistrat, fpc=~fpc)

rr <-  svyvar(~api00+avg.ed, dstrat) |> as.matrix() |>cov2cor() 
paste('True Correlation', rr[2,1])

wts <- 1/dstrat$prob 

p6 <- ggplot(apipop) + geom_point(aes(y = api00, x = avg.ed)) + theme(aspect.ratio = 1)+ labs(title='population', x = '', y = '')

 p5 <- ggplot(apistrat) + geom_point(aes(y = api00, x = avg.ed) ) +
   theme(aspect.ratio = 1)+ labs(title='sample', x = '', y = '') 

p2 <- ggplot(apistrat) + geom_point(aes(y = api00, x = avg.ed, size = wts), shape = 1 ) + theme(aspect.ratio = 1) + labs(title='bubble', , x = '', y = '')

p3 <- ggplot(apistrat) + geom_point(aes(y = api00, x = avg.ed, alpha = wts)) + theme(aspect.ratio = 1)+ labs(title ='transparency', x = '', y = '')

p4 <- ggplot(apistrat, aes(y = api00, x = avg.ed, z = wts)) +
  theme(aspect.ratio = 1)+ stat_summary_hex(  ) + labs(title = 'hex', x = '', y = '')

ids <- sample(1:nrow(apistrat), replace = TRUE, prob = wts )
p1 <- ggplot(apistrat) + geom_point(aes(y = api00, x = avg.ed) ) +
  theme(aspect.ratio = 1) + labs(title='subsampling', x = '', y = '')

(p6 + p1 + p2)/ (p5+p3+p4)  + 
  plot_layout(guides = "collect", axes = "collect", axis_titles = "collect") & 
  theme(legend.position = "none")


```


## Api growth vs parent education

```{r}

rr <-  svyvar(~growth + api99, dstrat) |> as.matrix() |> cov2cor() 
paste('True Correlation', rr[2,1])

wts <- 1/dstrat$prob 

p6 <- ggplot(apipop) + geom_point(aes(y = growth, x = api99) ) + 
  theme(aspect.ratio = 1) + labs(title = 'population', x = '', y = '')

 p5 <- ggplot(apistrat) + geom_point(aes(y = growth, x = avg.ed) ) +
   theme(aspect.ratio = 1) + labs(title='sample', x = '', y = '') 

p2 <- ggplot(apistrat) + geom_point(aes(y = growth, x = avg.ed, size = wts), shape = 1 ) + theme(aspect.ratio = 1) +
  labs(title = 'bubble', , x = '', y = '')

p3 <- ggplot(apistrat) + geom_point(aes(y = growth, x = avg.ed, alpha = wts)) + theme(aspect.ratio = 1) +
  labs(title ='transparency', x = '', y = '')

p4 <- ggplot(apistrat, aes(y = growth, x = avg.ed, z = wts)) +
  theme(aspect.ratio = 1 ) + stat_summary_hex(  ) + labs(title = 'hex', x = '', y = '')

ids <- sample(1:nrow(apistrat), replace = TRUE, prob = wts )
p1 <- ggplot(apistrat) + geom_point(aes(y = growth, x = avg.ed) ) +
  theme(aspect.ratio = 1) +
  labs(title='subsampling', x = '', y = '')

(p6 + p1 + p2)/ (p5+p3+p4)  + 
  plot_layout(guides = "collect", axes = "collect", axis_titles = "collect") & 
  theme(legend.position = "none")


```



# Things to try/explore

## Compare graphical optoins 

- Which scatter plot is better? 

- Set up an 'experiment' 

- Which one is better for correlation coef? better for Y-X relation? 

- Better than test for $H_0)\; \rho=0$ ? 

## Construct a new option 

- Get an estimate of bivariate $(Y,X)$ distribution 

<br>

- Obtain samples from the estimated bivariate distribution 

- Plot sampled points 

## High dimensions: tourr plots 

- tourr slice is a scatter plot 

- Can we extend options for tours with survey weights ?

<br> 

Applications: 

- Explore survey data 

- Boundary in unbalanced data 

- Big data 

## Models 

- Scatter plot is related to regression model

- Big discussion on weather use weights in linear models, economist (ignorability assumption )

- usual methods: fit model with and wothout using weights, compare fits (with a test?) and decide 

<br> 

Can having residual plot with sampling weigths help? 
